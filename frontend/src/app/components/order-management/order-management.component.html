<section class="h-100">
  <div class="card shadow-sm h-100">
    <div class="card-header bg-white p-2">
      <h2 class="h4 p-2"><i class="bi bi-clipboard-check me-2"></i>Gestión de pedidos</h2>
      <div class="row g-3">
        <div class="col-12">
          <form class="search-form d-flex align-items-center" (submit)="onSearch(searchInput.value); $event.preventDefault()">
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <div class="position-relative w-100 d-flex align-items-center">
                <input #searchInput type="text" class="form-control" placeholder="Buscar N° o nombre de camiseta..." [disabled]="selectedOrderId && orderExists(selectedOrderId)">
                <button *ngIf="searchInput.value" type="button" class="btn-clear" (click)="clearSearch(searchInput)" [disabled]="selectedOrderId && orderExists(selectedOrderId)">
                  <i class="bi bi-x"></i>
                </button>
              </div>
              <div class="dropdown">
                <button class="btn btn-primary filter-btn dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false" [disabled]="selectedOrderId && orderExists(selectedOrderId)">
                  <i class="bi bi-filter me-1"></i>Filtrar
                </button>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                  <li><a class="dropdown-item" [class.disabled]="selectedOrderId && orderExists(selectedOrderId)" (click)="filterByStatus('ENVIADO')">Enviados</a></li>
                  <li><a class="dropdown-item" [class.disabled]="selectedOrderId && orderExists(selectedOrderId)" (click)="filterByStatus('ACEPTADO')">Aceptados</a></li>
                  <li><a class="dropdown-item" [class.disabled]="selectedOrderId && orderExists(selectedOrderId)" (click)="filterByStatus('CANCELADO')">Cancelados</a></li>
                </ul>
              </div>
            </div>
          </form>
          <div *ngIf="searchError" class="alert alert-warning mt-2" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ searchError }}
          </div>
          <div class="filter-tags mt-3" *ngIf="currentStatusFilter !== 'TODOS'">
            <div class="filter-tag" [ngClass]="{
              'aceptado': currentStatusFilter === 'ACEPTADO',
              'enviado': currentStatusFilter === 'ENVIADO',
              'completado': currentStatusFilter === 'ENTREGADO',
              'cancelado': currentStatusFilter === 'CANCELADO',
              'disabled': selectedOrderId !== null
            }" (click)="selectedOrderId === null && filterByStatus('TODOS')">
              <span class="filter-tag-text">{{ currentStatusFilter === 'ACEPTADO' ? 'Aceptados' : 
                                             currentStatusFilter === 'ENVIADO' ? 'Enviados' : 
                                             currentStatusFilter === 'CANCELADO' ? 'Cancelados' : currentStatusFilter }}</span>
              <span class="filter-tag-close">
                <i class="bi bi-x"></i>
              </span>
            </div>
          </div>
        </div>
        <div class="col-12" *ngIf="selectedOrderId && orderExists(selectedOrderId)">
          <div class="filter-tags">
            <div class="filter-tag remove-selection" (click)="highlightSelectedOrder(null)">
              <span class="filter-tag-text">Quitar selección</span>
              <span class="filter-tag-close">
                <i class="bi bi-x"></i>
              </span>
            </div>
          </div>
        </div>
        <div class="col-12">
          <div class="tab-buttons-container">
            <div class="tab-buttons-wrapper d-flex flex-wrap">
              <button *ngFor="let tab of tabs" 
                class="tab-button py-2 px-3 text-center"
                [class.active]="tab.active"
                (click)="toggleOrderHistory(tab.isHistory)">
                <span class="tab-icon me-2">
                  <i [class]="tab.isHistory ? 'bi bi-clock-history' : 'bi bi-list-ul'"></i>
                </span>
                <span class="tab-text">{{ tab.title }}</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card-body p-0">
      <div class="orders-container">
        <div class="order-card p-md-3" *ngFor="let order of filteredOrders" [class.highlighted]="order.id_pedido === selectedOrderId">
          <div class="row">
            <div class="col-12">
              <div class="text-center mb-3">
                <h4 class="order-title h5 mb-2">Pedido N° {{ order.id_pedido }}</h4>
                <span class="badge" [ngClass]="{
                  'bg-info': order.estado === 'ENVIADO',
                  'bg-success': order.estado === 'ACEPTADO',
                  'bg-danger': order.estado === 'CANCELADO'
                }">{{ order.estado }}</span>
              </div>
            </div>
          </div>
          <div class="row g-3">
            <div class="col-12">
              <p class="mb-2 fs-7"><strong><i class="bi bi-person me-1"></i>Cliente: </strong> <span class="text-secondary fs-7">{{ getUserName(order.id_usuario) }}</span></p>
              <p class="mb-2 fs-7"><strong><i class="bi bi-currency-dollar me-1"></i>Total: </strong> <span class="text-secondary fs-7">${{ order.total }}</span></p>
              <p class="mb-2 fs-7"><strong><i class="bi bi-credit-card me-1"></i>Método de Pago: </strong> <span class="text-secondary fs-7">{{ formatFormasDePago(order.forma_de_pago) }}</span></p>
              <p class="mb-2 fs-7"><strong><i class="bi bi-calendar-date me-1"></i>Fecha: </strong> <span class="text-secondary fs-7">{{ order.fecha | date: 'dd/MM/yyyy' }}</span></p>
            </div>
          </div>
          <div class="mt-3">
            <h5 class="h6 mb-3"><i class="bi bi-box-seam me-1"></i>Productos</h5>
            <div class="product-grid">
              <div *ngFor="let detalle of order.detalles; let i = index" class="product-item">
                <div class="product-detail h-100">
                  <div class="d-flex flex-wrap flex-sm-nowrap align-items-start">
                    <div class="product-image-container">
                      <img [src]="detalle.producto.imagen" alt="{{ detalle.producto.nombre_producto }}" 
                           class="product-image img-fluid">
                    </div>
                    <div class="product-info">
                      <h6 class="product-title mb-1 fs-6 text-truncate">{{ detalle.producto.nombre_producto }}</h6>
                      <div class="product-specs">
                        <p class="product-description mb-1 fs-7"><strong>Talle: </strong> <span class="text-secondary fs-7">{{ getTalleFormatted(detalle.id_talle) }}</span></p>
                        <p class="product-description mb-1 fs-7"><strong>Cantidad: </strong> <span class="text-secondary fs-7">{{ detalle.cantidad }}</span></p>
                        <p class="product-description mb-1 fs-7"><strong>Precio: </strong> <span class="text-secondary fs-7">${{ detalle.producto.precio }}</span></p>
                        <p class="product-description mb-1 fs-7"><strong>Subtotal: </strong> <span class="text-secondary fs-7">${{ detalle.subtotal }}</span></p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="d-flex justify-content-end mt-3">
            <button *ngIf="order.estado !== 'CANCELADO' && order.estado !== 'ENVIADO' && order.estado !== 'ENTREGADO'" (click)="onCancelOrder(order.id_pedido)" class="btn btn-danger btn-sm"><i class="bi bi-x-circle me-1"></i>Cancelar Pedido</button>
            <a *ngIf="order.estado === 'ENVIADO'" href="https://www.andreani.com/?tab=seguir-envio" target="_blank" class="btn btn-primary btn-sm"><i class="bi bi-truck me-1"></i>Seguí tu Pedido</a>
          </div>
        </div>
        <div class="p-4 text-center" *ngIf="filteredOrders.length === 0">
          <p class="text-muted mb-0"><i class="bi bi-exclamation-circle me-1"></i>No se encontraron pedidos {{ showOrderHistory ? 'en el historial' : '' }}</p>
        </div>
      </div>
    </div>
  </div>
</section>